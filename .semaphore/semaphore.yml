version: v1.0
name: Toolbox S2 project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Run Tests
    task:
      prologue:
        commands:
          - sudo useradd -m -d /home/runner -s /bin/bash runner
          - echo "runner:runner"| sudo chpasswd
          - sudo su -l -c "mkdir -p /home/runner/.kerl/installs" runner
          - sudo usermod -a -G docker runner
          - checkout
          - cd ../
          - sudo mv classic-toolbox/ /home/runner/.toolbox
          - sudo su -l -c "bash .toolbox/install-toolbox" runner
          - sudo su -l -c "source .toolbox/toolbox" runner
          - sudo su -l -c "cd .toolbox" runner
      jobs:
      - name: Sem version tests
        commands:
          - sudo su -l -c "sem-version ruby 2.5.3" runner
          - sudo su -l -c "ruby --version | grep 2.5.3" runner
          - sudo su -l -c "sem-version ruby 2.5.2" runner
          - sudo su -l -c "ruby --version | grep 2.5.2" runner
          - sudo su -l -c "sem-version ruby 2.5.3" runner
          - sudo su -l -c "ruby --version | grep 2.5.3" runner
          - sudo su -l -c "sem-version ruby 2.3.7" runner
          - sudo su -l -c "ruby --version | grep 2.3.7" runner
          - sudo su -l -c "sem-version c 8" runner
          - sudo su -l -c "gcc --version | grep 8.3.0" runner
          - sudo su -l -c "sem-version cpp 7" runner
          - sudo su -l -c "gcc --version | grep 7.4.0" runner
          - sudo su -l -c "sem-version php 7.2.10" runner
          - sudo su -l -c "php -v | grep 7.2.10" runner
          - sudo su -l -c "sem-version php 7.0.32" runner
          - sudo su -l -c "php -v | grep 7.0.32" runner

      - name: MySQL
        commands:
          - sudo su -l -c "sem-service start mysql" runner
          - sudo su -l -c "mysql --host=0.0.0.0 -uroot -e 'create database fooo'" runner
          - sudo su -l -c "mysql --host=0.0.0.0 -uroot -e 'show databases' | grep fooo" runner
          - sudo su -l -c "mysql --host=0.0.0.0 -uroot -e 'SHOW VARIABLES like \'version\';' | grep 5.6" runner
          - sudo su -l -c "sem-service status mysql" runner
          - sudo su -l -c "sem-service stop mysql" runner
          - sudo su -l -c "sem-service start mysql 5.7" runner
          - sudo su -l -c "mysql --host=0.0.0.0 -uroot -e 'create database fooo'" runner
          - sudo su -l -c "mysql --host=0.0.0.0 -uroot -e 'show databases' | grep fooo" runner
          - sudo su -l -c "mysql --host=0.0.0.0 -uroot -e 'SHOW VARIABLES like \'version\';' | grep 5.7" runner
          - sudo su -l -c "sem-service status mysql" runner
          - sudo su -l -c "sem-service stop mysql" runner
          - sudo su -l -c "sem-service start mysql 8.0.19 --username=test --password=test --garbage else" runner
          - sudo su -l -c "mysql  -utest -ptest -e 'show databases'" runner
          - sudo su -l -c "mysql  -utest -ptest -e 'SHOW VARIABLES like \'version\';'" runner
          - sudo su -l -c "sem-service stop mysql" runner

      - name: PostgreSQL
        commands:
          - sudo su -l -c "sem-service start postgres" runner
          - sudo su -l -c "createdb -U postgres -h 0.0.0.0 fooo" runner
          - sudo su -l -c "psql -h 0.0.0.0 -U postgres -c '\l' | grep fooo" runner
          - sudo su -l -c "psql -h 0.0.0.0 -U postgres -c 'SELECT version()' | grep 9.6" runner
          - sudo su -l -c "sem-service status postgres" runner
          - sudo su -l -c "sem-service stop postgres" runner
          - sudo su -l -c "sem-service start postgres 11" runner
          - sudo su -l -c "createdb -U postgres -h 0.0.0.0 fooo" runner
          - sudo su -l -c "psql -h 0.0.0.0 -U postgres -c '\l' | grep fooo" runner
          - sudo su -l -c "psql -h 0.0.0.0 -U postgres -c 'SELECT version()' | grep 11" runner
          - sudo su -l -c "sem-service status postgres" runner
          - sudo su -l -c "sem-service stop postgres" runner
          - sudo su -l -c "sem-service start postgres 11 --username=xxx --password=xxx --db=xxx --garbage else" runner
          - sudo su -l -c "createdb -U xxx  -h 0.0.0.0 fooo" runner
          - sudo su -l -c "psql -h 0.0.0.0 -U xxx -c '\l'" runner
          - sudo su -l -c "psql -U xxx -c 'SELECT version()' | grep 11" runner
          - sudo su -l -c "sem-service status postgres" runner

      - name: Redis
        commands:
          - sudo su -l -c "sem-service start redis" runner
          - sudo su -l -c "sem-service status redis" runner
          - sudo su -l -c "sem-service stop redis" runner
          - sudo su -l -c "sem-service start redis 5" runner
          - sudo su -l -c "sem-service status redis" runner

      - name: Memcached
        commands:
          - sudo su -l -c "sem-service start memcached" runner
          - sudo su -l -c "sem-service status memcached" runner

      - name: RabbitMQ
        commands:
          - sudo su -l -c "sem-service start rabbitmq" runner
          - sudo su -l -c "sem-service status rabbitmq" runner

      - name: mongodb
        commands:
          - sudo su -l -c "sudo apt-get install -y mongodb-clients" runner
          - sudo su -l -c "sem-service start mongodb" runner
          - sudo su -l -c "curl http://localhost:27017 | grep 'It looks like you are trying to access MongoDB over HTTP on the native driver port.'" runner
          - sudo su -l -c "sem-service status mongodb" runner
          - sudo su -l -c "sem-service stop mongodb" runner
          - sudo su -l -c "sem-service start mongodb 3.2" runner
          - sudo su -l -c "curl http://localhost:27017 | grep 'It looks like you are trying to access MongoDB over HTTP on the native driver port.'" runner
          - sudo su -l -c "sem-service status mongodb" runner
          - sudo su -l -c "sem-service stop mongodb" runner
          - sudo su -l -c "sem-service stop mongodb" runner
          - sudo su -l -c "sem-service start mongodb 4.2 --username=xxx --password=xxx" runner
          - sudo su -l -c "echo 'show dbs' | mongo -u 'xxx' -p 'xxx' 127.0.0.1  --authenticationDatabase 'admin'" runner

      - name: elasticsearch
        commands:
          - sudo su -l -c "sem-service start elasticsearch" runner
          - sudo su -l -c "curl -XGET '0.0.0.0:9200/_cluster/health?pretty' | grep green" runner
          - sudo su -l -c "sem-service status elasticsearch" runner
          - sudo su -l -c "curl -XGET '0.0.0.0:9200' | grep 6.5.1" runner
          - sudo su -l -c "sem-service stop elasticsearch" runner
          - sudo su -l -c "sem-service start elasticsearch 6.5.2" runner
          - sudo su -l -c "curl -XGET '0.0.0.0:9200/_cluster/health?pretty' | grep green" runner
          - sudo su -l -c "sem-service status elasticsearch" runner
          - sudo su -l -c "curl -XGET '0.0.0.0:9200' | grep 6.5.2" runner
          - sudo su -l -c "sem-service stop elasticsearch" runner

      - name: Erlang change test
        commands:
          - sudo su -l -c "echo 'Erlang version'" runner
          - sudo su -l -c "erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().'  -noshell" runner
          - sudo su -l -c "sem-version erlang 20" runner
          - sudo su -l -c "erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().'  -noshell" runner
          - sudo su -l -c "sem-version erlang 21" runner
          - sudo su -l -c "erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().'  -noshell" runner

      - name: scala change test
        commands:
          - sudo su -l -c "echo 'actual scala version'" runner
          - sudo su -l -c "scala -version" runner
          - sudo su -l -c "sem-version scala 2.11" runner
          - sudo su -l -c "sem-version scala 2.12" runner

